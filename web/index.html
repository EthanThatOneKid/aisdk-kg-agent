<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turtle Graph Visualizer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cytoscape.js library for graph visualization -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"
    ></script>
    <!-- N3.js library for parsing Turtle data -->
    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <!-- Font for a cleaner look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    >
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      /* Style for the cytoscape container */
      #cy {
        width: 100%;
        height: 100%;
        display: block;
        background-color: #f9fafb; /* gray-50 */
        border-radius: 0.5rem; /* rounded-lg */
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 h-full flex flex-col p-4 md:p-6 lg:p-8"
  >
    <header class="mb-4">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
        Turtle Graph Visualizer
      </h1>
      <p class="text-gray-600 mt-1">
        Paste your Turtle (.ttl) graph data below and click "Render Graph" to
        visualize it.
      </p>
    </header>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
      <!-- Input Area -->
      <div class="flex flex-col">
        <label for="turtle-input" class="font-semibold mb-2"
        >Turtle Input</label>
        <textarea
          id="turtle-input"
          class="w-full flex-grow p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
          placeholder="@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix ex: <http://example.org/> .

ex:subject1 ex:predicate1 ex:object1 .
ex:subject2 rdf:type ex:SomeClass .
ex:object1 ex:another_predicate 'A literal value' ."
        ></textarea>
        <button
          id="render-btn"
          class="mt-4 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
        >
          Render Graph
        </button>
      </div>

      <!-- Graph Display Area -->
      <div class="flex flex-col min-h-[400px] lg:min-h-0">
        <h2 class="font-semibold mb-2">Graph Visualization</h2>
        <div
          id="cy-container"
          class="flex-grow border border-gray-300 rounded-lg shadow-sm overflow-hidden bg-white p-1"
        >
          <div id="cy"></div>
        </div>
        <div id="message-box" class="mt-2 text-center text-red-600 font-medium">
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const renderBtn = document.getElementById("render-btn");
        const turtleInput = document.getElementById("turtle-input");
        const messageBox = document.getElementById("message-box");
        let cy; // To hold the cytoscape instance

        // Set default turtle content
        turtleInput.value =
          `@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix ex: <http://example.com/ns#> .

ex:Vincent_van_Gogh a ex:Artist ;
    ex:bornIn "Netherlands" ;
    ex:created ex:The_Starry_Night .

ex:The_Starry_Night a ex:Painting ;
    rdfs:label "The Starry Night" .

ex:Artist rdfs:subClassOf ex:Person .
`;

        renderBtn.addEventListener("click", renderGraph);

        function renderGraph() {
          const turtleData = turtleInput.value;
          if (!turtleData.trim()) {
            showMessage(
              "Textarea is empty. Please provide Turtle data.",
            );
            return;
          }

          messageBox.textContent = "";

          try {
            const elements = parseTurtle(turtleData);
            if (
              elements.nodes.length === 0 && elements.edges.length === 0
            ) {
              showMessage(
                "Could not parse any nodes or edges from the input.",
              );
              return;
            }
            initializeCytoscape(elements);
          } catch (error) {
            console.error("Parsing or Rendering Error:", error);
            showMessage(
              `Error: ${error.message}. Please check the console for details.`,
            );
          }
        }

        function showMessage(message) {
          if (cy) {
            cy.destroy();
            cy = null;
          }
          document.getElementById("cy").innerHTML =
            `<div class="flex items-center justify-center h-full text-gray-500">${message}</div>`;
        }

        function parseTurtle(turtle) {
          const parser = new N3.Parser();
          const quads = parser.parse(turtle);

          const nodes = new Map();
          const edges = [];

          const addNode = (term) => {
            const id = term.value;
            if (!nodes.has(id)) {
              // Shorten URIs for better display
              let label = id;
              if (term.termType === "NamedNode") {
                try {
                  const url = new URL(id);
                  label = url.hash
                    ? url.hash.substring(1)
                    : url.pathname.split("/").pop() || id;
                } catch (e) {
                  // Not a valid URL, might be a prefixed name
                  label = id.split(/[:#]/).pop() || id;
                }
              } else if (term.termType === "Literal") {
                label = `"${term.value}"`; // Add quotes for literals
              }

              nodes.set(id, {
                data: { id, label: label, type: term.termType },
              });
            }
          };

          quads.forEach((quad) => {
            addNode(quad.subject);
            addNode(quad.object);

            let predicateLabel = quad.predicate.value;
            try {
              const url = new URL(predicateLabel);
              predicateLabel = url.hash
                ? url.hash.substring(1)
                : url.pathname.split("/").pop() || predicateLabel;
            } catch (e) {
              predicateLabel = predicateLabel.split(/[:#]/).pop() ||
                predicateLabel;
            }

            edges.push({
              data: {
                id: `${quad.subject.value}->${quad.object.value}`,
                source: quad.subject.value,
                target: quad.object.value,
                label: predicateLabel,
              },
            });
          });

          return { nodes: Array.from(nodes.values()), edges };
        }

        function initializeCytoscape(elements) {
          if (cy) {
            cy.destroy();
          }

          cy = cytoscape({
            container: document.getElementById("cy"),
            elements: elements,
            style: [
              {
                selector: "node",
                style: {
                  "background-color": (ele) => {
                    if (ele.data("type") === "Literal") {
                      return "#f59e0b"; // amber-500
                    }
                    return "#3b82f6"; // blue-500
                  },
                  "label": "data(label)",
                  "color": "#ffffff",
                  "text-valign": "center",
                  "text-halign": "center",
                  "font-size": "10px",
                  "text-wrap": "wrap",
                  "text-max-width": "80px",
                  "padding": "10px",
                  "width": "label",
                  "height": "label",
                  "shape": "round-rectangle",
                  "border-width": 1,
                  "border-color": "#9ca3af", // gray-400
                },
              },
              {
                selector: "edge",
                style: {
                  "width": 2,
                  "line-color": "#6b7280", // gray-500
                  "target-arrow-color": "#6b7280", // gray-500
                  "target-arrow-shape": "triangle",
                  "curve-style": "bezier",
                  "label": "data(label)",
                  "font-size": "8px",
                  "color": "#1f2937", // gray-800
                  "text-background-color": "#f9fafb", // gray-50
                  "text-background-opacity": 1,
                  "text-background-padding": "2px",
                  "text-background-shape": "round-rectangle",
                },
              },
            ],
            layout: {
              name: "grid", // A simple layout, can be changed to 'cose', 'circle', etc.
              padding: 30,
              fit: true,
              animate: true,
            },
          });

          // Apply a more complex layout if available, like cose
          // Note: For advanced layouts like 'cose-bilkent', you'd need to include the extension script.
          // Using a simpler, built-in layout for this example.
          const layout = cy.layout({
            name: "cose",
            animate: "end",
            padding: 50,
            nodeRepulsion: 400000,
            idealEdgeLength: 100,
            nodeOverlap: 20,
            fit: true,
          });
          layout.run();

          // Log node details on click
          cy.on("tap", "node", function (evt) {
            const node = evt.target;
            console.log("--- Clicked Node Details ---");
            console.log("ID (Full URI/Value):", node.id());
            console.log("Data Object:", node.data());
            console.log("--------------------------");
          });
        }

        // Perform an initial render on page load with the default content
        renderGraph();
      });
    </script>
  </body>
</html>
