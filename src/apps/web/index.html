<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turtle Graph Visualizer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Cytoscape.js library for graph visualization -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.28.1/cytoscape.min.js"
    ></script>
    <!-- N3.js library for parsing Turtle data -->
    <script src="https://unpkg.com/n3/browser/n3.min.js"></script>
    <!-- Font for a cleaner look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    >
    <style>
      body {
        font-family: "Inter", sans-serif;
      }

      /* Style for the cytoscape container */
      #cy {
        width: 100%;
        height: 100%;
        display: block;
        background-color: #f9fafb; /* gray-50 */
        border-radius: 0.5rem; /* rounded-lg */
      }

      /* Chat message animations */
      .chat-message {
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Scrollbar styling for chat */
      #chat-container::-webkit-scrollbar {
        width: 6px;
      }

      #chat-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }

      #chat-container::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }

      #chat-container::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 text-gray-800 h-full flex flex-col p-4 md:p-6 lg:p-8"
  >
    <header class="mb-4">
      <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
        Knowledge Graph Chat
      </h1>
      <p class="text-gray-600 mt-1">
        Chat with AI to generate and explore knowledge graphs in real-time.
      </p>
    </header>

    <div class="flex-grow grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
      <!-- Chat Area -->
      <div class="flex flex-col">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold">Conversation</h2>
          <div class="flex items-center space-x-2">
            <div id="status-indicator" class="text-sm text-gray-500">
              Ready
            </div>
            <button
              id="new-conversation-btn"
              class="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
              title="Start New Conversation"
            >
              + New
            </button>
            <button
              id="conversation-history-btn"
              class="px-3 py-1 text-xs bg-gray-500 text-white rounded hover:bg-gray-600 transition-colors"
              title="Conversation History"
            >
              ðŸ“š
            </button>
          </div>
        </div>

        <!-- Conversation History Panel (Hidden by default) -->
        <div
          id="conversation-history-panel"
          class="hidden border border-gray-300 rounded-lg bg-gray-50 mb-4 max-h-48 overflow-y-auto"
        >
          <div class="p-3">
            <h3 class="text-sm font-semibold text-gray-700 mb-2">
              Recent Conversations
            </h3>
            <div id="conversation-list" class="space-y-1">
              <!-- Conversation items will be populated here -->
            </div>
          </div>
        </div>

        <div
          id="chat-container"
          class="flex-grow border border-gray-300 rounded-lg shadow-sm bg-white p-4 overflow-y-auto mb-4"
        >
          <div id="chat-messages" class="space-y-4">
            <!-- Messages will be added here -->
          </div>
        </div>

        <div class="flex gap-2">
          <input
            id="message-input"
            type="text"
            class="flex-1 p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
            placeholder="Type your message here..."
            disabled
          />
          <button
            id="send-btn"
            class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
            disabled
          >
            Send
          </button>
        </div>
      </div>

      <!-- Graph Display Area -->
      <div class="flex flex-col min-h-[400px] lg:min-h-0">
        <h2 class="font-semibold mb-2">Knowledge Graph</h2>
        <div
          id="cy-container"
          class="flex-grow border border-gray-300 rounded-lg shadow-sm overflow-hidden bg-white p-1"
        >
          <div id="cy"></div>
        </div>
        <div id="message-box" class="mt-2 text-center text-red-600 font-medium">
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const messageInput = document.getElementById("message-input");
        const sendBtn = document.getElementById("send-btn");
        const chatMessages = document.getElementById("chat-messages");
        const statusIndicator = document.getElementById(
          "status-indicator",
        );
        const messageBox = document.getElementById("message-box");
        let cy; // To hold the cytoscape instance
        let eventSource = null; // To hold the SSE connection
        let conversationId = getConversationIdFromUrl() ||
          `chat-${Date.now()}`;
        let isGenerating = false;
        let conversationHistory = loadConversationHistory();

        // Enable input and send button
        messageInput.disabled = false;
        sendBtn.disabled = false;

        // Initialize conversation
        initializeConversation();

        // Add welcome message
        addMessage(
          "assistant",
          "Hello! I'm your AI assistant. Send me a message and I'll generate a knowledge graph for you. What would you like to explore?",
        );

        // Event listeners
        sendBtn.addEventListener("click", sendMessage);
        messageInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Conversation history event listeners
        document.getElementById("new-conversation-btn")
          .addEventListener("click", createNewConversation);
        document.getElementById("conversation-history-btn")
          .addEventListener("click", toggleConversationHistory);

        // Browser history integration
        window.addEventListener("popstate", (event) => {
          const urlConversationId = getConversationIdFromUrl();
          if (
            urlConversationId && urlConversationId !== conversationId
          ) {
            switchToConversation(urlConversationId);
          }
        });

        // Conversation History Management Functions
        function getConversationIdFromUrl() {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get("conversationId");
        }

        function updateUrlWithConversationId(id) {
          const url = new URL(window.location);
          url.searchParams.set("conversationId", id);
          window.history.replaceState(
            { conversationId: id },
            "",
            url.toString(),
          );
        }

        function loadConversationHistory() {
          const history = localStorage.getItem("conversationHistory");
          return history ? JSON.parse(history) : [];
        }

        function saveConversationHistory() {
          localStorage.setItem(
            "conversationHistory",
            JSON.stringify(conversationHistory),
          );
        }

        function addToConversationHistory(id, title, timestamp) {
          const existingIndex = conversationHistory.findIndex((conv) =>
            conv.id === id
          );
          const conversation = {
            id,
            title: title ||
              `Conversation ${conversationHistory.length + 1}`,
            timestamp: timestamp || new Date().toISOString(),
          };

          if (existingIndex >= 0) {
            conversationHistory[existingIndex] = conversation;
          } else {
            conversationHistory.unshift(conversation);
          }

          // Keep only last 50 conversations
          if (conversationHistory.length > 50) {
            conversationHistory = conversationHistory.slice(0, 50);
          }

          saveConversationHistory();
          updateConversationHistoryUI();
        }

        function initializeConversation() {
          // Update URL with current conversation ID
          updateUrlWithConversationId(conversationId);

          // Add current conversation to history if not already present
          const existingConv = conversationHistory.find((conv) =>
            conv.id === conversationId
          );
          if (!existingConv) {
            addToConversationHistory(
              conversationId,
              `New Conversation ${conversationHistory.length + 1}`,
            );
          }

          // Load conversation data if it exists
          loadConversationData(conversationId);
        }

        function loadConversationData(id) {
          const conversationData = localStorage.getItem(
            `conversation_${id}`,
          );
          if (conversationData) {
            try {
              const data = JSON.parse(conversationData);
              // Restore chat messages
              if (data.messages) {
                chatMessages.innerHTML = "";
                data.messages.forEach((msg) => {
                  addMessage(msg.role, msg.content, msg.isProgress);
                });
              }
              // Restore graph if it exists
              if (
                data.graphElements &&
                data.graphElements.nodes.length > 0
              ) {
                initializeCytoscape(data.graphElements);
              }
            } catch (error) {
              console.error("Error loading conversation data:", error);
            }
          }
        }

        function saveConversationData(id) {
          const messages = Array.from(chatMessages.children).map(
            (msgEl) => {
              // Find the message content using the .message-content class
              const messageContent = msgEl.querySelector(
                ".message-content",
              );
              const content = messageContent
                ? messageContent.textContent
                : "";

              return {
                role: msgEl.classList.contains("user-message")
                  ? "user"
                  : "assistant",
                content: content,
                isProgress: msgEl.classList.contains(
                  "progress-message",
                ),
              };
            },
          );

          const graphElements = cy
            ? {
              nodes: cy.nodes().map((node) => ({
                data: node.data(),
              })),
              edges: cy.edges().map((edge) => ({
                data: edge.data(),
              })),
            }
            : { nodes: [], edges: [] };

          const conversationData = {
            messages,
            graphElements,
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem(
            `conversation_${id}`,
            JSON.stringify(conversationData),
          );
        }

        function createNewConversation() {
          // Save current conversation before switching
          saveConversationData(conversationId);

          const newId = `chat-${Date.now()}`;
          conversationId = newId;

          // Use pushState to add to browser history
          const url = new URL(window.location);
          url.searchParams.set("conversationId", newId);
          window.history.pushState(
            { conversationId: newId },
            "",
            url.toString(),
          );

          // Clear current chat
          chatMessages.innerHTML = "";
          if (cy) {
            cy.destroy();
            cy = null;
          }

          // Add to history
          addToConversationHistory(
            newId,
            `New Conversation ${conversationHistory.length + 1}`,
          );

          // Add welcome message
          addMessage(
            "assistant",
            "Hello! I'm your AI assistant. Send me a message and I'll generate a knowledge graph for you. What would you like to explore?",
          );
        }

        function switchToConversation(id) {
          if (id === conversationId) return;

          // Save current conversation
          saveConversationData(conversationId);

          // Switch to new conversation
          conversationId = id;

          // Use pushState to add to browser history
          const url = new URL(window.location);
          url.searchParams.set("conversationId", id);
          window.history.pushState(
            { conversationId: id },
            "",
            url.toString(),
          );

          loadConversationData(id);

          // Update history UI
          updateConversationHistoryUI();
        }

        function toggleConversationHistory() {
          const panel = document.getElementById(
            "conversation-history-panel",
          );
          const btn = document.getElementById(
            "conversation-history-btn",
          );

          if (panel.classList.contains("hidden")) {
            panel.classList.remove("hidden");
            btn.classList.remove("bg-gray-500");
            btn.classList.add("bg-blue-500");
            updateConversationHistoryUI();
          } else {
            panel.classList.add("hidden");
            btn.classList.remove("bg-blue-500");
            btn.classList.add("bg-gray-500");
          }
        }

        function updateConversationHistoryUI() {
          const conversationList = document.getElementById(
            "conversation-list",
          );
          conversationList.innerHTML = "";

          if (conversationHistory.length === 0) {
            conversationList.innerHTML =
              '<p class="text-sm text-gray-500 text-center py-2">No conversations yet</p>';
            return;
          }

          conversationHistory.forEach((conv, index) => {
            const isActive = conv.id === conversationId;
            const convElement = document.createElement("div");
            convElement.className =
              `p-2 rounded cursor-pointer text-sm transition-colors ${
                isActive
                  ? "bg-blue-100 border border-blue-300 text-blue-800"
                  : "hover:bg-gray-100 text-gray-700"
              }`;

            convElement.innerHTML = `
              <div class="font-medium truncate">${conv.title}</div>
              <div class="text-xs text-gray-500">${
              new Date(conv.timestamp).toLocaleString()
            }</div>
            `;

            convElement.addEventListener("click", () => {
              if (!isActive) {
                switchToConversation(conv.id);
                toggleConversationHistory(); // Hide panel after selection
              }
            });

            conversationList.appendChild(convElement);
          });
        }

        function sendMessage() {
          const message = messageInput.value.trim();
          if (!message || isGenerating) return;

          // Add user message to chat
          addMessage("user", message);

          // Update conversation title if this is the first user message
          const userMessages = Array.from(
            chatMessages.querySelectorAll(".user-message"),
          );
          if (userMessages.length === 1) {
            const title = message.length > 50
              ? message.substring(0, 50) + "..."
              : message;
            addToConversationHistory(conversationId, title);
          }

          // Save conversation data
          saveConversationData(conversationId);

          // Clear input and disable controls
          messageInput.value = "";
          setGenerating(true);

          // Start graph generation
          generateGraph(message);
        }

        function generateGraph(inputText) {
          // Close any existing connection
          if (eventSource) {
            eventSource.close();
          }

          // Add progress message
          addMessage(
            "assistant",
            "Generating knowledge graph...",
            true,
          );

          // Create SSE connection
          const url = new URL(
            `/api/v1/graphs/${encodeURIComponent(conversationId)}/sse`,
            window.location.origin,
          );
          url.searchParams.set("query", inputText);

          eventSource = new EventSource(url.toString());

          eventSource.addEventListener("connected", (event) => {
            updateStatus("Connected", "text-blue-500");
          });

          eventSource.addEventListener("progress", (event) => {
            updateStatus("Generating...", "text-yellow-500");
            updateLastMessage(
              `Generating knowledge graph... (${event.data})`,
            );
          });

          eventSource.addEventListener("result", (event) => {
            updateStatus("Rendering...", "text-purple-500");
            updateLastMessage("Graph generated, rendering...");

            try {
              const elements = parseTurtle(event.data);
              if (
                elements.nodes.length === 0 &&
                elements.edges.length === 0
              ) {
                updateLastMessage("Generated graph is empty");
                showMessage("Generated graph is empty");
                return;
              }

              // Save conversation data after successful generation
              saveConversationData(conversationId);
              initializeCytoscape(elements);
              updateLastMessage(
                "Knowledge graph generated successfully!",
              );
              updateStatus("Complete", "text-green-500");
            } catch (error) {
              console.error("Rendering Error:", error);
              updateLastMessage(
                `Error rendering graph: ${error.message}`,
              );
              showMessage(`Error rendering graph: ${error.message}`);
            }
          });

          eventSource.addEventListener("complete", (event) => {
            updateStatus("Complete", "text-green-500");
            eventSource.close();
            eventSource = null;
            setGenerating(false);
          });

          eventSource.addEventListener("error", (event) => {
            updateStatus("Error", "text-red-500");
            updateLastMessage(`Generation error: ${event.data}`);
            showMessage(`Generation error: ${event.data}`);
            eventSource.close();
            eventSource = null;
            setGenerating(false);
          });

          eventSource.onerror = (error) => {
            console.error("SSE Error:", error);
            updateStatus("Connection Error", "text-red-500");
            updateLastMessage("Connection error. Please try again.");
            showMessage("Connection error. Please try again.");
            if (eventSource) {
              eventSource.close();
              eventSource = null;
            }
            setGenerating(false);
          };
        }

        function addMessage(sender, content, isProgress = false) {
          const messageDiv = document.createElement("div");
          messageDiv.className = `flex ${
            sender === "user" ? "justify-end" : "justify-start"
          } chat-message ${
            sender === "user" ? "user-message" : "assistant-message"
          } ${isProgress ? "progress-message" : ""}`;

          const messageContent = document.createElement("div");
          messageContent.className =
            `message-content max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${
              sender === "user"
                ? "bg-blue-600 text-white"
                : isProgress
                ? "bg-yellow-100 text-yellow-800 border border-yellow-300"
                : "bg-gray-100 text-gray-800"
            }`;

          messageContent.textContent = content;
          messageDiv.appendChild(messageContent);

          // Add timestamp
          const timestamp = document.createElement("div");
          timestamp.className = `text-xs text-gray-500 mt-1 ${
            sender === "user" ? "text-right" : "text-left"
          }`;
          timestamp.textContent = new Date().toLocaleTimeString();
          messageDiv.appendChild(timestamp);

          chatMessages.appendChild(messageDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          return messageContent;
        }

        function updateLastMessage(content) {
          const lastMessage = chatMessages.lastElementChild
            ?.querySelector(".message-content");
          if (lastMessage) {
            lastMessage.textContent = content;
          }
        }

        function updateStatus(text, className) {
          statusIndicator.textContent = text;
          statusIndicator.className = `text-sm ${className}`;
        }

        function setGenerating(generating) {
          isGenerating = generating;
          messageInput.disabled = generating;
          sendBtn.disabled = generating;
        }

        function showMessage(message) {
          if (cy) {
            cy.destroy();
            cy = null;
          }
          document.getElementById("cy").innerHTML =
            `<div class="flex items-center justify-center h-full text-gray-500">${message}</div>`;
        }

        // Cleanup on page unload
        window.addEventListener("beforeunload", () => {
          if (eventSource) {
            eventSource.close();
          }
        });

        function parseTurtle(turtle) {
          const parser = new N3.Parser();
          const quads = parser.parse(turtle);

          const nodes = new Map();
          const edges = [];

          const addNode = (term) => {
            const id = term.value;
            if (!nodes.has(id)) {
              // Shorten URIs for better display
              let label = id;
              if (term.termType === "NamedNode") {
                try {
                  const url = new URL(id);
                  label = url.hash
                    ? url.hash.substring(1)
                    : url.pathname.split("/").pop() || id;
                } catch (e) {
                  // Not a valid URL, might be a prefixed name
                  label = id.split(/[:#]/).pop() || id;
                }
              } else if (term.termType === "Literal") {
                label = `"${term.value}"`; // Add quotes for literals
              }

              nodes.set(id, {
                data: { id, label: label, type: term.termType },
              });
            }
          };

          quads.forEach((quad) => {
            addNode(quad.subject);
            addNode(quad.object);

            let predicateLabel = quad.predicate.value;
            try {
              const url = new URL(predicateLabel);
              predicateLabel = url.hash
                ? url.hash.substring(1)
                : url.pathname.split("/").pop() || predicateLabel;
            } catch (e) {
              predicateLabel = predicateLabel.split(/[:#]/).pop() ||
                predicateLabel;
            }

            edges.push({
              data: {
                id: `${quad.subject.value}->${quad.object.value}`,
                source: quad.subject.value,
                target: quad.object.value,
                label: predicateLabel,
              },
            });
          });

          return { nodes: Array.from(nodes.values()), edges };
        }

        function initializeCytoscape(elements) {
          if (cy) {
            cy.destroy();
          }

          cy = cytoscape({
            container: document.getElementById("cy"),
            elements: elements,
            style: [
              {
                selector: "node",
                style: {
                  "background-color": (ele) => {
                    if (ele.data("type") === "Literal") {
                      return "#f59e0b"; // amber-500
                    }
                    return "#3b82f6"; // blue-500
                  },
                  "label": "data(label)",
                  "color": "#ffffff",
                  "text-valign": "center",
                  "text-halign": "center",
                  "font-size": "10px",
                  "text-wrap": "wrap",
                  "text-max-width": "80px",
                  "padding": "10px",
                  "width": "label",
                  "height": "label",
                  "shape": "round-rectangle",
                  "border-width": 1,
                  "border-color": "#9ca3af", // gray-400
                },
              },
              {
                selector: "edge",
                style: {
                  "width": 2,
                  "line-color": "#6b7280", // gray-500
                  "target-arrow-color": "#6b7280", // gray-500
                  "target-arrow-shape": "triangle",
                  "curve-style": "bezier",
                  "label": "data(label)",
                  "font-size": "8px",
                  "color": "#1f2937", // gray-800
                  "text-background-color": "#f9fafb", // gray-50
                  "text-background-opacity": 1,
                  "text-background-padding": "2px",
                  "text-background-shape": "round-rectangle",
                },
              },
            ],
            layout: {
              name: "grid", // A simple layout, can be changed to 'cose', 'circle', etc.
              padding: 30,
              fit: true,
              animate: true,
            },
          });

          // Apply a more complex layout if available, like cose
          // Note: For advanced layouts like 'cose-bilkent', you'd need to include the extension script.
          // Using a simpler, built-in layout for this example.
          const layout = cy.layout({
            name: "cose",
            animate: "end",
            padding: 50,
            nodeRepulsion: 400000,
            idealEdgeLength: 100,
            nodeOverlap: 20,
            fit: true,
          });
          layout.run();

          // Log node details on click
          cy.on("tap", "node", function (evt) {
            const node = evt.target;
            console.log("--- Clicked Node Details ---");
            console.log("ID (Full URI/Value):", node.id());
            console.log("Data Object:", node.data());
            console.log("--------------------------");
          });
        }

        // Chat interface is ready - no initial render needed
      });
    </script>
  </body>
</html>
